<!DOCTYPE html>
<!-- saved from url=(0035)http://m.b5m.com/activelistings/198 -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta charset="utf-8">        
        <link rel="apple-touch-icon-precomposed" href="http://static-web.b5m.com/wap/img/collect-logo/b5m-collect-logo.png">
        <title>确认订单</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimal-ui">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="format-detection" content="telephone=no, email=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <!-- uc强制竖屏 -->
        <meta name="screen-orientation" content="portrait">
        <meta name="full-screen" content="yes">
        <meta name="browsermode" content="application">
        <!-- QQ强制竖屏 -->
        <meta name="x5-orientation" content="portrait">
        <meta name="x5-fullscreen" content="true">
        <meta name="x5-page-mode" content="app">
        <meta name="keywords" content="山城速购">
        <meta name="description" content="山城速购">
         <link rel="stylesheet" href="{skin:css/common.css}" type="text/css">
         <link rel="stylesheet" href="{skin:css/order.css}" type="text/css">
     	<script src="{theme:javascript/jquery-1.9.1.min.js}"></script>
     	<script src="{theme:javascript/order.js}"></script>
		{js:artTemplate}
		<script type='text/javascript' src='{theme:javascript/orderFormClass.js}'></script>
     </head>
<body style="background:#efefef;">
<script type='text/javascript'>
//创建订单表单实例
orderFormInstance = new orderFormClass();

//DOM加载完毕
jQuery(function(){
	//使用红包按钮
	$('#ticket_a').click(function()
	{
		//第一次打开时生成缓存数据
		if($.trim($('#ticket_show_box').text()) == '')
		{
			var ticketList = {echo:JSON::encode($this->prop)};
			for(var index in ticketList)
			{
				var ticketHtml = template.render('ticketTrTemplate',{item:ticketList[index]});
				$('#ticket_show_box').append(ticketHtml);
			}
		}

		$(this).toggleClass('fold');
		$(this).toggleClass('unfold');
		$('#ticket_box').toggle('slow');
	});

	//初始化地域联动JS模板
	template.compile("areaTemplate",areaTemplate);

	//收货地址数据
	orderFormInstance.addressInit("{$this->defaultAddressId}");

	//初始化自提点数据(自添)
	takeselfInit("{$this->custom['takeself']}");

	//配送方式初始化
	orderFormInstance.deliveryInit("{$this->custom['delivery']}");

	

	
	//设置是否免运费
	orderFormInstance.freeFreight = {echo:$this->freeFreight ? 1 : 0};

	//支付方式
	orderFormInstance.paymentInit("{$this->custom['payment']}");

	//商品价格
	orderFormInstance.goodsSum = "{$this->final_sum}";
	
});

/*
 * 根据上次选择进行自提点初始化
 */
function takeselfInit(id){
	//自提点初始化
	$('[name="takeself"]').val(id);
		if(id>0){
			$.ajax({
			  dataType: "json",
			  async:false,
			  url: '{url:block/getOneTakeself}',
			  data: {'id':id},
			  success: function(data){
			  	$('#takeself').html(template.render('takeselfTemplate',{"item":data}));
			  },
			  
			});
			$('input[name=takeself]').removeClass('hide');
		}	
	}



//[delivery]根据省份地区ajax获取配送方式
function get_delivery()
{
	orderFormInstance.deliveryPrice = 0;
	var province = $('[name="province"]').val();
	var delivery = $('[name="delivery_id"]:checked').val();
	if(!province || !delivery)
	{
		return;
	}

	$('[id^="deliveryFeeBox_"]').each(function(i)
	{
		var idValue = $(this).attr('id');
		var dataArray = idValue.split("_");
		$.getJSON("{url:/block/order_delivery}",{"province":province,"distribution":delivery,"goodsId":dataArray[1],"productId":dataArray[2],"num":dataArray[3]},function(content){
			//地区无法送达
			if(content.if_delivery == 1)
			{
				alert('您选择地区部分商品无法送达');
				$('#'+idValue).html("<span style='color:red'>无法送达</span>");
			}
			else
			{
				//免运费
				if(orderFormInstance.freeFreight == 1)
				{
					var html = "活动免运费";
					content.price = 0;
					orderFormInstance.doAccount();
				}
				else
				{
					var html = "￥"+content.price;
					orderFormInstance.deliveryPrice += parseFloat(content.price);
					orderFormInstance.doAccount();
				}

				//允许保价
				if(content.protect_price > 0)
				{
					html += "<br /><label title='￥"+content.protect_price+"'><input type='checkbox' value='"+content.protect_price+"' name='insured["+dataArray[1]+"_"+dataArray[2]+"]' onchange='selectProtect(this);' />保价</label>";
				}
				$('#'+idValue).html(html);
			}
		});
	});
}

//保价
function selectProtect(obj)
{
	if($(obj).attr('checked') == 'checked')
	{
		orderFormInstance.protectPrice += parseFloat(obj.value);
	}
	else
	{
		orderFormInstance.protectPrice -= parseFloat(obj.value);
	}
	orderFormInstance.doAccount();
}

//添加代金券
function add_ticket()
{
	var ticket_num = $('#ticket_num').val();
	var ticket_pwd = $('#ticket_pwd').val();

	if(ticket_num == '' || ticket_pwd == '')
	{
		alert('请填写卡号和密码');
		return '';
	}

	$.getJSON('{url:/block/add_download_ticket}',{"ticket_num":ticket_num,"ticket_pwd":ticket_pwd},function(content){
		if(content.isError == false)
		{
			is_success = true;
			$('[name="ticket_id"]').each(
				function()
				{
					if($(this).val() == content.data.id)
					{
						alert('代金券已经存在，不要重复添加');
						is_success = false;
					}
				}
			);

			if(is_success)
			{
				var ticketHtml = template.render('ticketTrTemplate',{item:content.data});
				$('#ticket_show_box').append(ticketHtml);
				$('[name="ticket_id"]').attr('checked',true);
				$('[name="ticket_id"]:last').trigger('click');
			}
			$('#ticket_num').val('');
			$('#ticket_pwd').val('');
		}
		else
		{
			alert(content.message);
		}
	});
}

//取消红包
function cancel_ticket()
{
	$('#ticket_a').trigger('click');
	$('[name="ticket_id"]').attr('checked',false);
	orderFormInstance.doAccount();
}

//选择自提点
function selectTakeself(deliveryId)
{
	if(!deliveryId)var deliveryId = '';
	var takeselfParam = $('#takeselfParam td');
	var pro = takeselfParam.eq(0).text();
	var city = takeselfParam.eq(1).text();
	var area = takeselfParam.eq(2).text();
	var paramStr = "/pro/"+pro+"/city/"+city+"/area/"+area;
	art.dialog.open("{url:/block/takeself}"+paramStr,{
		title:'选择自提点',
		okVal:'选择',
		ok:function(iframeWin, topWin)
		{
			var takeselfJson = $(iframeWin.document).find('[name="takeselfItem"]:checked').val();

			if(!takeselfJson)
			{
				alert('请选择自提点');
				return false;
			}
			var json = $.parseJSON(takeselfJson);
			$('#takeself'+deliveryId).empty();
			$('[name="takeself"]').removeClass('hide').val(json.id).attr('checked','checked');
			$('#takeself'+deliveryId).html(template.render('takeselfTemplate',{"item":json}));
			return true;
		}
	});
}

</script>
     <div class="pages">
         <header class="wap-header">
	   		 <div class="wap-topbar">
		        <div class="h-left"><a href="javascript:history.go(-1);" title="返回"></a></div>
		        <div class="h-center">
		            <h1>确认订单</h1>
		        </div>
	   		 </div>
		</header>
     	<div style=""> </div>
     	<div class="qrdd">
     		<a class="dz" href="{url:simple/address}">
	     		<span class="shname">收货人：王云英</span><span class="float_rt">18025671234</span>
	     		<p><i></i>山西省阳泉市矿区水泉沟4-04-12</p>
     		</a>
     	</div>
     	<form>
     	<div class="qrdd qrdds">
     		<!-- 商品详情-->
     		<div class="qr_xq">
     		<a href="detail">
     			<div class="tjxq_img">
     				<img src="{skin:images/files/T1UidsBX_s1RCvBVdK.jpg}"/>
     			</div>
     			<div class="tjxq_tit">
	     			<p>2015秋冬款Steve Madden思美女靴做旧系带粗跟中筒靴</p>
	     			<p class="tjxq_ge">颜色分类：A24 cognac 红色，尺码：37</p>
	     			
	     			
	     			<!-- <span>七天退换</span> -->
	     		</div>
	     		<div class="tjxq_sum">
	     			<p class="sum">
		     			价格：<span>￥189</span>
		     			数量：<span>x1</span>
		     		</p>
	     		</div>
	     		</a>
     		</div>
     		<!-- 商品详情结束 -->
     		
     		<div class="qrdds_zf">
     			<h4>支付方式</h4>
     			
     			<select>
     				<option>请选择支付方式</option>
     				<option>支付宝</option>
     				<option>余额宝</option>
     			</select>
     			<p style="height: 25px;">配送方式</p>
     			<select>
     				<option>请选配送方式</option>
     				<option>申通</option>
     				<option>圆通</option>
     				<option>邮政</option>
     			</select>
     			<input class="xt" type="text" placeholder="买家留言"/>
     			
     		</div>
     		<div class="qrdds_sum">
     			<p>共1件商品，合计<b>￥1880</b></p>
     		</div>
     		
     	</div>
     	<div class="qrdd qrdds">
	     	<span class="yhj">是否开发票</span>
	     	<span id="fpx"  class="yhj_check"></span>
	     	<div class="fapiao">
	     		<span class="fa_tit">发票抬头</span>
	     		<input class="xt" type="text" placeholder="个人"/>
	     	</div>		
     	
     	</div>
     	<div class="qrdd qrdds">
     		<span class="yhj">优惠劵使用</span>
     		<span id="checks" class="yhj_check"></span>
     	</div>
     	<div class="qrdd qrdds">
     		<span class="yhj">当前积分可抵用<b>￥10</b></span>
     		<span class="yhj_check"></span>
     	</div>
     	<div style="height:55px;"></div>
     	<div class="anniu">
     		<input class="but" type="button" value="确定提交" onClick="location.href='zhf'"/>
     	</div>
     	</form>
     </div>
  </body>
</html>